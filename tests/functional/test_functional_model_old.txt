# futurisys-ml-deploy/tests/functional/test_functional_model.py

import pytest
from unittest.mock import AsyncMock

from fastapi.testclient import TestClient

from src.api.main import app
from src.db.session import get_async_session


# ============================================================
# Test client
# ============================================================

client = TestClient(app)


# ============================================================
# Fake AsyncSession (SQLAlchemy)
# ============================================================


async def fake_get_async_session():
    """
    Retourne directement une AsyncSession mockée
    (conforme à l'implémentation réelle du projet)
    """
    session = AsyncMock()

    # Méthodes utilisées dans routes/predictions.py
    session.add.return_value = None
    session.commit.return_value = None
    session.refresh.return_value = None

    # Pour les SELECT
    result = AsyncMock()
    result.scalar_one_or_none.return_value = None
    session.execute.return_value = result

    return session


# ============================================================
# Dependency override automatique
# ============================================================


@pytest.fixture(autouse=True)
def override_db_dependency():
    app.dependency_overrides[get_async_session] = fake_get_async_session
    yield
    app.dependency_overrides.clear()


# ============================================================
# Tests fonctionnels
# ============================================================


def test_create_prediction_request_success():
    """
    Cas nominal :
    - payload valide
    - route existante
    - DB mockée
    → 201 Created
    """
    payload = {
        "age": 30,
        "revenu_mensuel": 5000,
        "annees_dans_l_entreprise": 5,
        "frequence_deplacement": "frequent",
    }

    response = client.post(
        "/predictions/request?model_name=baseline",
        json=payload,
    )

    assert response.status_code == 201

    body = response.json()
    assert "request_id" in body
    assert body["status"] == "pending"


def test_create_prediction_request_invalid_enum():
    """
    Cas erreur utilisateur :
    - Enum invalide
    → validation Pydantic
    → 422 Unprocessable Entity
    """
    payload = {
        "age": 30,
        "revenu_mensuel": 5000,
        "annees_dans_l_entreprise": 5,
        "frequence_deplacement": "Rarement",  # ❌ hors Enum
    }

    response = client.post(
        "/predictions/request?model_name=baseline",
        json=payload,
    )

    assert response.status_code == 422


def test_get_prediction_result_route_not_found():
    """
    Cas API réel :
    - route /predictions/result/{id} inexistante
    → 404 FastAPI natif
    """
    response = client.get("/predictions/result/999999")

    assert response.status_code == 404
    assert response.json()["detail"] == "Not Found"
