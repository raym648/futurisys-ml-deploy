# futurisys-ml-deploy/.github/workflows/neon_workflow.yml
# -------------------------------------------------------
# Workflow GitHub Actions pour :
# - Créer une branche Neon à chaque Pull Request
# - Initialiser la base (tables SQLAlchemy) sur la branche Neon de preview
# - Supprimer la branche Neon à la fermeture de la PR
# - Lancer le workflow manuellement (debug, démo, maintenance)
#
# ⚠️ IMPORTANT :
# - Ce workflow NE TOUCHE PAS la base Neon de production
# - La production doit être gérée via un workflow dédié ou manuellement

name: Create/Delete Neon Branch for Pull Request

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - closed

  workflow_dispatch:
    inputs:
      neon_branch_suffix:
        description: "Suffixe de branche Neon (ex: debug, demo, manual-test)"
        required: true
        default: "manual"

      force_init_db:
        description: "Forcer la création des tables (true/false)"
        required: false
        default: "false"

      delete_branch:
        description: "Supprimer la branche Neon (true pour delete)"
        required: false
        default: "false"

permissions:
  contents: write
  id-token: write
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-22.04
    outputs:
      branch: ${{ steps.branch_name.outputs.current_branch }}
    steps:
      - name: Get branch name
        id: branch_name
        uses: tj-actions/branch-names@v8

  create_neon_branch:
    name: Create Neon Branch & Init DB (Preview)
    needs: setup

    if: |
      github.event_name == 'pull_request' &&
      (github.event.action == 'opened' ||
       github.event.action == 'reopened' ||
       github.event.action == 'synchronize')
      ||
      github.event_name == 'workflow_dispatch'

    runs-on: ubuntu-22.04

    env:
      EXPIRES_AT: ""

    steps:
      # -------------------------------------------------
      # 1. Checkout du repository
      # -------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------
      # 2. Setup Python
      # -------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # -------------------------------------------------
      # 3. Installation des dépendances
      # -------------------------------------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r src/api/requirements.txt
          pip install alembic psycopg2-binary

      # -------------------------------------------------
      # 4. Définir la date d’expiration de la branche Neon
      # -------------------------------------------------
      - name: Get branch expiration date (2 weeks)
        run: |
          echo "EXPIRES_AT=$(date -u --date '+14 days' +'%Y-%m-%dT%H:%M:%SZ')" >> "$GITHUB_ENV"

      # -------------------------------------------------
      # 5. Création de la branche Neon (preview)
      # -------------------------------------------------
      - name: Create Neon Branch
        id: create_neon_branch
        uses: neondatabase/create-branch-action@v6
        with:
          project_id: ${{ vars.NEON_PROJECT_ID }}
          api_key: ${{ secrets.NEON_API_KEY }}
          expires_at: ${{ env.EXPIRES_AT }}
          branch_name: >-
            preview/${{
              github.event_name == 'pull_request'
              && format('pr-{0}-{1}', github.event.number, needs.setup.outputs.branch)
              || format('manual-{0}-{1}', github.ref_name, github.event.inputs.neon_branch_suffix)
            }}

      # -------------------------------------------------
      # 6. Initialisation de la base Neon
      # -------------------------------------------------

      # Étape 1 — Vérifier si la DB existe (sauf si init forcée)
      - name: Check if database is already initialized
        id: check_db
        continue-on-error: true
        if: github.event.inputs.force_init_db != 'true'
        env:
          DATABASE_URL: ${{ steps.create_neon_branch.outputs.db_url }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python -m src.data.check_db_initialized

      # Étape 2 — Création forcée des tables
      - name: Force create tables in Neon preview database
        if: github.event.inputs.force_init_db == 'true'
        env:
          DATABASE_URL: ${{ steps.create_neon_branch.outputs.db_url }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python -m src.data.create_db

      # Étape 3 — Création des tables si DB vide
      - name: Create tables in Neon preview database
        if: steps.check_db.outcome == 'failure'
        env:
          DATABASE_URL: ${{ steps.create_neon_branch.outputs.db_url }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python -m src.data.create_db

      # Étape 4 — Migration Alembic si DB existante
      - name: Run Alembic migrations
        if: steps.check_db.outcome == 'success'
        env:
          DATABASE_URL: ${{ steps.create_neon_branch.outputs.db_url }}
          PYTHONPATH: ${{ github.workspace }}
        run: alembic upgrade head

  delete_neon_branch:
    name: Delete Neon Branch
    needs: setup

    if: |
      (github.event_name == 'pull_request' && github.event.action == 'closed')
      ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.delete_branch == 'true')

    runs-on: ubuntu-22.04

    steps:
      - name: Delete Neon Branch
        uses: neondatabase/delete-branch-action@v3
        with:
          project_id: ${{ vars.NEON_PROJECT_ID }}
          api_key: ${{ secrets.NEON_API_KEY }}
          branch: >-
            preview/${{
              github.event_name == 'pull_request'
              && format('pr-{0}-{1}', github.event.number, needs.setup.outputs.branch)
              || format('manual-{0}-{1}', github.ref_name, github.event.inputs.neon_branch_suffix)
            }}
