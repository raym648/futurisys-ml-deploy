# futurisys-ml-deploy/.github/workflows/neon_workflow.yml
# -------------------------------------------------------
# Workflow GitHub Actions pour :
# - Créer une branche Neon à chaque Pull Request
# - Initialiser la base (tables SQLAlchemy) sur la branche Neon de preview
# - Supprimer la branche Neon à la fermeture de la PR
#
# ⚠️ IMPORTANT :
# - Ce workflow NE TOUCHE PAS la base Neon de production
# - La production doit être gérée via un workflow dédié ou manuellement

name: Create/Delete Neon Branch for Pull Request

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - closed

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}

jobs:
  setup:
    name: Setup
    outputs:
      branch: ${{ steps.branch_name.outputs.current_branch }}
    runs-on: ubuntu-22.04
    steps:
      - name: Get branch name
        id: branch_name
        uses: tj-actions/branch-names@v8

  create_neon_branch:
    name: Create Neon Branch & Init DB (Preview)
    needs: setup

    if: github.event_name == 'pull_request' && (
        github.event.action == 'opened' ||
        github.event.action == 'reopened' ||
        github.event.action == 'synchronize'
      )
    
    runs-on: ubuntu-22.04

    env:
      EXPIRES_AT: ""

    steps:
      # -------------------------------------------------
      # 1. Checkout du repository
      # -------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------
      # 2. Setup Python
      # -------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # -------------------------------------------------
      # 3. Installation des dépendances
      # -------------------------------------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r src/api/requirements.txt
          pip install alembic psycopg2-binary

      # -------------------------------------------------
      # 4. Définir la date d’expiration de la branche Neon
      # -------------------------------------------------
      - name: Get branch expiration date (2 weeks)
        id: get_expiration_date
        run: |
          echo "EXPIRES_AT=$(date -u --date '+14 days' +'%Y-%m-%dT%H:%M:%SZ')" >> "$GITHUB_ENV"

      # -------------------------------------------------
      # 5. Création de la branche Neon (preview)
      # -------------------------------------------------
      - name: Create Neon Branch
        id: create_neon_branch
        uses: neondatabase/create-branch-action@v6
        with:
          project_id: ${{ vars.NEON_PROJECT_ID }}
          branch_name: preview/pr-${{ github.event.number }}-${{ needs.setup.outputs.branch }}
          api_key: ${{ secrets.NEON_API_KEY }}
          expires_at: ${{ env.EXPIRES_AT }}

      # -------------------------------------------------
      # 6. Création des tables SQLAlchemy sur la branche Neon
      # -------------------------------------------------
      # Étape 1 — Vérifier la DB
      - name: Check if database is already initialized
        id: check_db
        env:
          DATABASE_URL: ${{ steps.create_neon_branch.outputs.db_url_with_pooler }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python -m src.data.check_db_initialized
        continue-on-error: true

      # Étape 2 — Créer les tables seulement si nécessaire
      - name: Create tables in Neon preview database
        if: steps.check_db.outcome == 'failure'
        env:
          DATABASE_URL: ${{ steps.create_neon_branch.outputs.db_url_with_pooler }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python -m src.data.create_db

      # Étape 3 — Migration (si DB existe)
      - name: Run Alembic migrations
        if: steps.check_db.outcome == 'success'
        env:
          DATABASE_URL: ${{ steps.create_neon_branch.outputs.db_url_with_pooler }}
          PYTHONPATH: ${{ github.workspace }}
        run: alembic upgrade head

  delete_neon_branch:
    name: Delete Neon Branch
    needs: setup

    if: github.event_name == 'pull_request' && github.event.action == 'closed'

    runs-on: ubuntu-22.04

    steps:
      - name: Delete Neon Branch
        uses: neondatabase/delete-branch-action@v3
        with:
          project_id: ${{ vars.NEON_PROJECT_ID }}
          branch: preview/pr-${{ github.event.number }}-${{ needs.setup.outputs.branch }}
          api_key: ${{ secrets.NEON_API_KEY }}
